---
title: "Chicdiff Vignette"
author: "Jonathan Cairns,William Orchard, Valeriya Malysheva, Mikhail Spivakov"
date: 15th November, 2018
VignetteIndexEntry: 
output:
  BiocStyle::html_document:
    toc: true

---
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Chicdiff Vignette}
%\VignetteDepends{}
%\VignetteKeywords{Chicdiff}
%\VignettePackage{Chicdiff}
-->
```{r style, echo = FALSE, results = 'asis'}
# BiocInstaller::biocLite("BiocStyle") # if needed...
BiocStyle::markdown()
```

# Introduction

Chicdiff is a method for detecting statistically significant differential interactions in Capture HiC data. This vignette will walk you through a typical Chicdiff analysis. 

A typical Chicdiff job for two biological replicates of CHi-C data takes 30 min wall-clock time and uses 15G RAM. Time and memory usage depends on data sparcity.

------ ---------------------------------------------------------
*NOTE* A wrapper to perform this type of analysis, called *runChicdiff.R*, is provided as part of *chicdiffTools*, which is available from our [Github repository](https://github.com/RegulatoryGenomicsGroup/chicdiff/). Refer to the *chicdiffTools* README for more information.


---------------------------------------------------------------

The statistical foundations of Chicdiff are presented in a separate paper that is currently available as a preprint [ref!!!]. Briefly, Chicdiff combines moderated differential testing for count data implemented in DESeq2 with CHi-C-specific procedures for signal normalisation and p-value weighting. To increase power, CHiCDiff combines reads across several fragments surrounding each significantly interacting region for each bait. Background estimates from CHiCAGO are used to construct a custom scaling matrix that is used in differential testing. The count and scaling matrices are provided as input for the DESeq2 package that tests each interaction for differences between conditions using a negative binomial model with moderated dispersion estimation. DESeq2 implements both pairwise testing between conditions, as well as likelihood ratio tests for multi-condition differences. The p-values from either of these tests are then submitted to the weighting procedure as described below. Due to high distance-dependent variations of signal-to-noise ratios and effect sizes in CHi-C data CHicdiff performs non-uniform multiple testing correction, such that weaker signals at longer distances are corrected more vigorously. We use IHW to learn the weights on the p-values obtained from a differential testing of fragment pairs in a 'training set' that is sampled from the full count data for each sample. We use interaction distance bins as covariates to assign weights to each distance bin in a manner that maximises the overall fraction of rejected null hypotheses. The distance-dependent weights learned this way are applied to the p-values in the test set, and the resulting weighted p-values are reported to the user.



--------- ------------------------------------------------------
*WARNING* The data set used in this tutorial comes from the package *ChicdiffData*. This package contains small parts (chromosome 19) of published Promoter Capture HiC data sets in human Naive CD4+ T cells and Monocytes [@Javierre2016] - note that we are only reusing raw data from this publication. Do not use any of these sample input data for purposes other than training. 

---------------------------------------------------------------


In this vignette, we use the Naive CD4+ T cells and Monocytes data [@Javierre2016]:

```{r, message=FALSE}
library(Chicdiff)
library(ChicdiffData)
```


# Workflow

## Input files required

Before you start, you will need: 

1. Two restriction map information files ("design files"):

- Restriction map file (.rmap) - a bed file containing coordinates of the restriction fragments. By default, 4 columns: chr, start, end, fragmentID.
- Bait map file (.baitmap) - a bed file containing coordinates of the baited restriction fragments, and their associated annotations. By default, 5 columns: chr, start, end, fragmentID, baitAnnotation. The regions specified in this file, including their fragmentIDs, must be an exact subset of those in the .rmap file. The baitAnnotation is a text field that is used only to annotate the output and plots.

We recommend that you put all five of these files into the same directory (that we refer to as designDir). An example of a valid design folder, for a sample of the CD4+ and Monocytes data used in this vignette, is provided in the ChicdiffData package, as follows.

```{r}
dataPath <- system.file("extdata", package="ChicdiffData")
testDesignDir <- file.path(dataPath, "designDir")
dir(testDesignDir)
```

------ ---------------------------------------------------------
*NOTE* These are same files that were used to run CHiCAGO.

---------------------------------------------------------------


2. *Peakfile*, obtained from CHiCAGO run and containing the scores for the interactions considered by CHiCAGO.

Example *peakfile* file is provided in the ChicdiffData package:

```{r}
peakFiles <- file.path(dataPath,"peakMatrix_cd4_mono_unmerged.txt")
```

3. You will also need input data files, which should be in CHiCAGO input format, *.chinput*. You can obtain *.chinput* files from aligned Capture Hi-C BAM files by running ``bam2chicago.sh``, available as part of ``chicagoTools``. (To obtain BAM files from raw fastq files, use a Hi-C alignment & QC pipeline such as [HiCUP](http://www.bioinformatics.babraham.ac.uk/projects/hicup/).

Example *.chinput* files are provided in the ChicdiffData package, as follows:

```{r}
testDataPath_CD4 <- file.path(dataPath, "CD4")
testDataPath_Mono <- file.path(dataPath, "monocytes")
dir(testDataPath_CD4)
dir(testDataPath_Mono)
```

To run Chicdff *.chinput* files have to be presented in the follwing way:

```{r}
targetChs <- list(
    CD4 = c(NCD4_22 = file.path(testDataPath_CD4, "unitTest_CD41.chinput"),
            NCD4_23 = file.path(testDataPath_CD4, "unitTest_CD42.chinput")
            ),
    
    Mono = c(Mon_2 = file.path(testDataPath_Mono, "unitTest_Mono2.chinput"),
            Mon_3 = file.path(testDataPath_Mono, "unitTest_Mono3.chinput")
            )
  )
```

------ --------------------------------------------------------
*NOTE* The names of every file should match the column name of the correpsonding data set in the *peakfile* file.

---------------------------------------------------------------

4. Finally you will need *.Rda* input data files, which should be produced in CHiCAGO run. These files contain information on interactions, including their coordinates, bait- and OtherEnd-specific data etc.

Example *.Rda* files are provided in the ChicdiffData package, as follows:

```{r}
testDataPath_rda <- system.file("data", package="ChicdiffData")
dir(testDataPath_rda)
```

To run Chicdff *.Rda* files have to be presented in the follwing way:

```{r}
targetRDSorRDAs <- list(
  CD4 = c(NCD4_22 = file.path(testDataPath_rda, "unitTest_CD41.RDa"),
          NCD4_23 = file.path(testDataPath_rda, "unitTest_CD42.RDa")
          ),
  
  Mono = c(Mon_2 = file.path(testDataPath_rda, "unitTest_Mono2.RDa"),
           Mon_3 = file.path(testDataPath_rda, "unitTest_Mono3.RDa")
  )
)
```

------ --------------------------------------------------------
*NOTE* As for *targetChs*, the names of every file should match the column name of the correpsonding data set in the *peakfile* file.

---------------------------------------------------------------

## Example workflow

We run Chicdiff on the test data as follows. 
First, we set up chicdiff experiment settings with ``setchicExperiment()``:


```{r, message=FALSE, warning = FALSE}
library(Chicdiff)
defchic.settings <- setchicExperiment(designDir = testDesignDir, targetRDSorRDAs = targetRDSorRDAs, targetChs = targetChs, peakfiles = peakFiles)
```

OPTIONAL: You can modify settings directly in the command line. For example, to set up the running mode to parallel run the following line:

```{r, message=FALSE, warning = FALSE}
library(Chicdiff)
defchic.settings <- setchicExperiment(designDir = testDesignDir, targetRDSorRDAs = targetRDSorRDAs, targetChs = targetChs, peakfiles = peakFiles, settings = list(parallel=TRUE))
```

Alternatively, you can provide your prefered parameters in a *settingsFile* file:

```{r, message=FALSE, warning = FALSE}
library(Chicdiff)
settingsFile = file.path(dataPath,"SettingsFile.txt")
defchic.settings <- setchicExperiment(designDir = testDesignDir, targetRDSorRDAs = targetRDSorRDAs, targetChs = targetChs, peakfiles = peakFiles, settingsFile = settingsFile)
```

*Omit this step unless you know which settings you wish to alter*.

------ ---------------------------------------------------------
*NOTE* Settings override settings from settingsFile. Both override default settings.

---------------------------------------------------------------

Finally, we run the pipeline with ``chicdiffPipeline()``:

```{r, eval=FALSE}
output <- chicdiffPipeline(defchic.settings)
```

## Output plots

``chicdiffPipeline()`` produces a number of plots, that are saved in the working directory.

The plots are as follows (an explanation follows):

```{r, echo=FALSE, message=FALSE}
output <- chicdiffPipeline(defchic.settings)
```
